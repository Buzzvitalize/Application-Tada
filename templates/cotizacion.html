{% extends 'base.html' %}
{% block title %}Nueva Cotización{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Nueva Cotización</h1>
<form method="post" id="quotation-form" class="space-y-6 card max-w-4xl mx-auto">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <div class="space-y-2">
    <input id="client-search" class="input" list="client-options" placeholder="Seleccione cliente">
    <datalist id="client-options">
      {% for c in clients %}
      <option data-id="{{ c.id }}" value="{{ c.name }} - {{ c.identifier }}"></option>
      {% endfor %}
    </datalist>
    <input type="hidden" name="client_id" id="client-id">
    <div id="new-client" class="grid md:grid-cols-2 gap-4">
      <input name="client_name" placeholder="Nombre" class="input" id="client-name">
      <input id="client-last" name="client_last_name" placeholder="Apellido" class="input">
      <input name="client_identifier" placeholder="Cédula" class="input id-mask" id="client-identifier" data-doc-type="cedula">
      <input name="client_phone" placeholder="Teléfono" class="input phone-mask">
      <input name="client_email" placeholder="Email" class="input">
      <input name="client_street" placeholder="Calle" class="input">
      <input name="client_sector" placeholder="Sector" class="input">
      <input name="client_province" placeholder="Provincia" class="input">
      <div class="flex space-x-4 col-span-2">
        <label><input type="radio" name="client_type" value="final" checked> Consumidor Final</label>
        <label><input type="radio" name="client_type" value="fiscal"> Comprobante Fiscal</label>
      </div>
    </div>
  </div>
  <div class="grid md:grid-cols-3 gap-4">
    <input name="seller" placeholder="Vendedor" class="input" required>
    <select name="payment_method" id="payment-method" class="input">
      <option value="Efectivo">Efectivo</option>
      <option value="Transferencia">Transferencia bancaria</option>
    </select>
    <select name="bank" id="bank-select" class="input hidden">
      <option value="">Seleccione banco</option>
      <option>Banco Popular</option>
      <option>Banco BHD</option>
      <option>Banco Banreservas</option>
      <option>Banesco</option>
    </select>
  </div>
  <div>
    <h2 class="text-xl font-semibold mb-2">Productos</h2>
    <datalist id="product-options">
      {% for p in products %}
      <option data-id="{{ p.id }}" data-unit="{{ p.unit }}" data-price="{{ p.price }}" value="{{ p.code }} - {{ p.name }}"></option>
      {% endfor %}
    </datalist>
    <div id="productos">
      <div class="grid grid-cols-1 sm:grid-cols-7 gap-2 mb-2 product-row">
        <input class="input product-input" list="product-options" placeholder="Producto">
        <input type="hidden" name="product_id[]" class="product-id">
        <input class="input unit-field" placeholder="Unidad" readonly>
        <input class="input price-field" placeholder="Precio" readonly>
        <input name="product_quantity[]" placeholder="Cantidad" class="input qty-field" required>
        <input name="product_discount[]" placeholder="Desc. %" class="input disc-field">
        <input class="input total-field" placeholder="Total" readonly>
        <button type="button" class="btn-secondary remove-product">Eliminar</button>
      </div>
    </div>
    <button type="button" id="add-product" class="btn-secondary mt-2">Agregar Producto</button>
  </div>
  <textarea name="note" placeholder="Nota" class="input w-full"></textarea>
  <button class="btn-primary">Guardar</button>
</form>
{% endblock %}

{% block scripts %}
<script>
window.addEventListener('load', () => {
  const clientInput = document.getElementById('client-search');
  const clientIdField = document.getElementById('client-id');
  const newClient = document.getElementById('new-client');
  function toggleClient(){
    const opt = document.querySelector(`#client-options option[value="${clientInput.value}"]`);
    clientIdField.value = opt ? opt.dataset.id : '';
    const isNew = !opt;
    newClient.style.display = isNew ? 'grid' : 'none';
    newClient.querySelectorAll('input').forEach(i => i.required = isNew);
  }
  clientInput.addEventListener('input', toggleClient);
  toggleClient();

  const typeRadios=document.querySelectorAll('input[name="client_type"]');
  const idField=document.getElementById('client-identifier');
  const lastField=document.getElementById('client-last');
  function toggleType(){
    if(document.querySelector('input[name="client_type"]:checked').value==='final'){
      lastField.classList.remove('hidden');
      lastField.required=true;
      idField.placeholder='Cédula';
      idField.required=false;
      idField.dataset.docType='cedula';
    }else{
      lastField.classList.add('hidden');
      lastField.required=false;
      idField.placeholder='RNC *';
      idField.required=true;
      idField.dataset.docType='rnc';
    }
    applyDocMask(idField);
  }
  typeRadios.forEach(r=>r.addEventListener('change',toggleType));
  toggleType();

  const paySelect=document.getElementById('payment-method');
  const bankSelect=document.getElementById('bank-select');
  paySelect.addEventListener('change',()=>{
    bankSelect.classList.toggle('hidden', paySelect.value!=='Transferencia');
  });

  function bindProduct(row) {
    const input = row.querySelector('.product-input');
    const idField = row.querySelector('.product-id');
    const unit = row.querySelector('.unit-field');
    const price = row.querySelector('.price-field');
    const qty = row.querySelector('.qty-field');
    const disc = row.querySelector('.disc-field');
    const total = row.querySelector('.total-field');
    const removeBtn = row.querySelector('.remove-product');
    function calc(){
      const p=parseFloat(price.value)||0;
      const q=parseFloat(qty.value)||0;
      const d=parseFloat(disc.value)||0;
      total.value=(p*q*(1-d/100)).toFixed(2);
    }
    input.addEventListener('input', function() {
      const opt = document.querySelector(`#product-options option[value="${input.value}"]`);
      if(opt){
        idField.value = opt.dataset.id;
        unit.value = opt.dataset.unit || '';
        price.value = opt.dataset.price ? parseFloat(opt.dataset.price).toFixed(2) : '';
      }else{
        idField.value='';
        unit.value='';
        price.value='';
      }
      calc();
    });
    qty.addEventListener('input', calc);
    disc.addEventListener('input', calc);
    removeBtn.addEventListener('click', () => {
      row.remove();
    });
  }

  const templateRow = document.querySelector('.product-row').cloneNode(true);
  document.getElementById('add-product').addEventListener('click', function() {
    const container = document.getElementById('productos');
    const row = templateRow.cloneNode(true);
    row.querySelectorAll('input').forEach(i => i.value = '');
    container.appendChild(row);
    bindProduct(row);
  });

  document.querySelectorAll('.product-row').forEach(bindProduct);
});
</script>
{% endblock %}
