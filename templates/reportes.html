{% extends 'base.html' %}
{% block title %}Reportes{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Reportes</h1>

<form id="filters" class="card mb-6 grid md:grid-cols-5 gap-4" method="get" action="{{ url_for('reportes') }}">
  <input type="date" name="fecha_inicio" value="{{ filters.fecha_inicio }}" class="input">
  <input type="date" name="fecha_fin" value="{{ filters.fecha_fin }}" class="input">
  <select name="estado" class="input">
    <option value="">Todos los estados</option>
    {% for s in statuses %}
    <option value="{{ s }}" {% if filters.estado==s %}selected{% endif %}>{{ s }}</option>
    {% endfor %}
  </select>
  <select name="categoria" class="input">
    <option value="">Todas las categorías</option>
    {% for c in categories %}
    <option value="{{ c }}" {% if filters.categoria==c %}selected{% endif %}>{{ c }}</option>
    {% endfor %}
  </select>
  <div class="relative">
    <select id="exportTipo" class="input mb-2">
      <option value="detalle">Detalle</option>
      <option value="resumen">Resumen</option>
    </select>
    <button type="button" id="exportBtn" class="btn w-full">Exportar</button>
    <div id="exportMenu" class="absolute right-0 mt-2 w-40 bg-white border rounded shadow hidden z-10">
      <a href="#" data-format="csv" class="block px-4 py-2 hover:bg-gray-100">CSV</a>
      <a href="#" data-format="xlsx" class="block px-4 py-2 hover:bg-gray-100">Excel</a>
      <a href="#" data-format="pdf" class="block px-4 py-2 hover:bg-gray-100">PDF</a>
    </div>
  </div>
  <div class="md:col-span-5 flex flex-wrap gap-2 mt-2">
    <button class="btn" type="submit">Filtrar</button>
    <button class="btn" type="button" id="resetFilters">Reset</button>
    <div class="flex gap-1">
      <button type="button" data-range="today" class="btn text-xs">Hoy</button>
      <button type="button" data-range="7" class="btn text-xs">7 días</button>
      <button type="button" data-range="month" class="btn text-xs">Mes</button>
      <button type="button" data-range="year" class="btn text-xs">Año</button>
    </div>
    <span id="exportSpinner" class="hidden items-center text-sm text-gray-600">Generando...</span>
    <a href="{{ url_for('export_history') }}" class="btn ml-auto">Historial</a>
  </div>
</form>

<div class="grid md:grid-cols-6 gap-4 mb-6">
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ventas Totales</div>
    <div class="text-2xl font-bold">{{ stats.total_sales | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Clientes Únicos</div>
    <div class="text-2xl font-bold">{{ stats.unique_clients }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Facturas</div>
    <div class="text-2xl font-bold">{{ stats.invoices }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Pendientes</div>
    <div class="text-2xl font-bold">{{ stats.pending | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Pagadas</div>
    <div class="text-2xl font-bold">{{ stats.paid | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ticket Promedio</div>
    <div class="text-2xl font-bold">{{ stats.avg_ticket | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ticket Prom. Mes</div>
    <div class="text-2xl font-bold">{{ stats.avg_ticket_month | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Ticket Prom. Año</div>
    <div class="text-2xl font-bold">{{ stats.avg_ticket_year | money }}</div>
  </div>
  <div class="card text-center">
    <div class="text-sm text-gray-500">Retención</div>
    <div class="text-2xl font-bold">{{ '%.1f%%'|format(stats.retention) }}</div>
  </div>
</div>

<div class="grid md:grid-cols-2 gap-6 mb-6">
  <div class="card p-4 flex flex-col items-center">
    <h3 class="text-sm mb-2">Ventas por categoría</h3>
    <canvas id="catChart" width="718" height="329"></canvas>
  </div>
  <div class="card p-4 flex flex-col items-center">
    <h3 class="text-sm mb-2">Ventas en el tiempo</h3>
    <canvas id="timeChart" width="718" height="329"></canvas>
  </div>
</div>
<div class="grid md:grid-cols-2 gap-6 mb-6">
  <div class="card p-4 flex flex-col items-center">
    <h3 class="text-sm mb-2">Estado de facturas</h3>
    <canvas id="statusChart" width="718" height="329"></canvas>
  </div>
  <div class="card p-4 flex flex-col items-center">
    <h3 class="text-sm mb-2">Ventas por mes</h3>
    <canvas id="monthlyChart" width="718" height="329"></canvas>
  </div>
</div>
<div class="card p-4 mb-6 flex flex-col items-center">
  <h3 class="text-sm mb-2">Tendencia 24 meses</h3>
  <canvas id="trendChart" width="718" height="329"></canvas>
</div>

<div class="card overflow-x-auto mb-6">
  <h2 class="text-xl font-semibold mb-2">Ventas por Categoría</h2>
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">Categoría</th>
        <th class="p-2 text-right">Cantidad</th>
        <th class="p-2 text-right">Promedio</th>
        <th class="p-2 text-right">Total</th>
      </tr>
    </thead>
    <tbody>
      {% if sales_by_category %}
      {% for cat, qty, avg, total in sales_by_category %}
      <tr class="border-t">
        <td class="p-2">{{ cat or 'Sin categoría' }}</td>
        <td class="p-2 text-right">{{ qty }}</td>
        <td class="p-2 text-right">{{ avg | money }}</td>
        <td class="p-2 text-right">{{ total | money }}</td>
      </tr>
      {% endfor %}
      {% else %}
      <tr class="border-t"><td class="p-2 text-center" colspan="4">Sin datos</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="card overflow-x-auto mb-6">
  <h2 class="text-xl font-semibold mb-2">Top 5 Clientes</h2>
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">Cliente</th>
        <th class="p-2 text-right">Total</th>
      </tr>
    </thead>
    <tbody>
      {% if top_clients %}
      {% for name, total in top_clients %}
      <tr class="border-t">
        <td class="p-2">{{ name }}</td>
        <td class="p-2 text-right">{{ total | money }}</td>
      </tr>
      {% endfor %}
      {% else %}
      <tr class="border-t"><td class="p-2 text-center" colspan="2">Sin datos</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="card overflow-x-auto">
  <h2 class="text-xl font-semibold mb-2">Detalle de Facturas</h2>
  <table class="min-w-full text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="p-2 text-left">Cliente</th>
        <th class="p-2 text-left">Fecha</th>
        <th class="p-2 text-left">Estado</th>
        <th class="p-2 text-right">Total</th>
      </tr>
    </thead>
    <tbody>
      {% if invoices %}
      {% for inv in invoices %}
      <tr class="border-t">
        <td class="p-2">{{ inv.client.name }}</td>
        <td class="p-2">{{ inv.date.strftime('%Y-%m-%d') }}</td>
        <td class="p-2">{{ inv.status }}</td>
        <td class="p-2 text-right">{{ inv.total | money }}</td>
      </tr>
      {% endfor %}
      {% else %}
      <tr class="border-t"><td class="p-2 text-center" colspan="4">Sin datos</td></tr>
      {% endif %}
    </tbody>
  </table>
  <div class="flex justify-end gap-2 mt-2">
    {% if pagination.page > 1 %}
    <a class="btn" href="{{ url_for('reportes', page=pagination.page-1, **filters) }}">Anterior</a>
    {% endif %}
    {% if pagination.page < pagination.pages %}
    <a class="btn" href="{{ url_for('reportes', page=pagination.page+1, **filters) }}">Siguiente</a>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const currency = new Intl.NumberFormat('es-DO',{style:'currency',currency:'DOP'});

const catCtx = document.getElementById('catChart');
const catChart = new Chart(catCtx, {
  type: 'pie',
  data: {
    labels: {{ cat_labels|tojson }},
    datasets: [{ data: {{ cat_totals|tojson }}, backgroundColor:['#1e3a8a','#3b82f6','#60a5fa','#93c5fd','#cbd5e1'] }]
  },
  options:{
    plugins:{
      tooltip:{
        callbacks:{
          label: ctx => {
            const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
            const pct = total? (ctx.parsed/total*100).toFixed(1):0;
            return `${ctx.label}: ${currency.format(ctx.parsed)} (${pct}%)`;
          }
        }
      }
    }
  }
});
catCtx.onclick = function(evt){
  const points = catChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
  if(points.length){
    const label = catChart.data.labels[points[0].index];
    const params = new URLSearchParams(new FormData(document.getElementById('filters')));
    params.set('categoria', label);
    window.location = '?' + params.toString();
  }
};

const timeCtx = document.getElementById('timeChart');
const dateCounts = {{ date_counts|tojson }};
new Chart(timeCtx, {
  type: 'line',
  data: {
    labels: {{ date_labels|tojson }},
    datasets: [{ label: 'Ventas en el tiempo', data: {{ date_totals|tojson }}, borderColor: '#1e3a8a', fill:false, count: dateCounts }]
  },
  options: {
    plugins: {
      tooltip: {
        callbacks: {
          label: ctx => `${currency.format(ctx.parsed.y)} (${ctx.dataset.count[ctx.dataIndex]} ventas)`
        }
      }
    }
  }
});

const statusCtx = document.getElementById('statusChart');
const statusChart = new Chart(statusCtx, {
  type: 'pie',
  data: {labels: {{ status_labels|tojson }}, datasets: [{data: {{ status_values|tojson }}, backgroundColor:['#1e3a8a','#facc15','#16a34a']} ]},
});
statusCtx.onclick = function(evt){
  const points = statusChart.getElementsAtEventForMode(evt,'nearest',{intersect:true},true);
  if(points.length){
    const label = statusChart.data.labels[points[0].index];
    const params = new URLSearchParams(new FormData(document.getElementById('filters')));
    params.set('estado', label);
    window.location = '?' + params.toString();
  }
};

const monthlyCtx = document.getElementById('monthlyChart');
new Chart(monthlyCtx, {
  type: 'bar',
  data: {
    labels: {{ months|tojson }},
    datasets: [
      {label: 'Año actual', data: {{ year_current|tojson }}, backgroundColor:'#1e3a8a'},
      {label: 'Año anterior', data: {{ year_prev|tojson }}, backgroundColor:'#93c5fd'}
    ]
  }
});

const trendCtx = document.getElementById('trendChart');
new Chart(trendCtx, {
  type: 'line',
  data: {
    labels: {{ (trend_24|default([], true))|map(attribute='month', default='')|list|tojson }},
    datasets: [{label:'Últimos 24 meses', data: {{ (trend_24|default([], true))|map(attribute='total', default=0)|list|tojson }}, borderColor:'#1e3a8a', fill:false}]
  }
});

const exportBtn = document.getElementById('exportBtn');
const exportMenu = document.getElementById('exportMenu');
const spinner = document.getElementById('exportSpinner');
const exportTipo = document.getElementById('exportTipo');
exportBtn.addEventListener('click', () => exportMenu.classList.toggle('hidden'));
exportMenu.querySelectorAll('a').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    spinner.classList.remove('hidden');
    const params = new URLSearchParams(new FormData(document.getElementById('filters')));
    window.location = `{{ url_for('export_reportes') }}?formato=${a.dataset.format}&tipo=${exportTipo.value}&` + params.toString();
    setTimeout(() => spinner.classList.add('hidden'), 3000);
    exportMenu.classList.add('hidden');
  });
});

document.getElementById('resetFilters').addEventListener('click', () => {
  window.location = '{{ url_for('reportes') }}';
});
document.querySelectorAll('[data-range]').forEach(btn => {
  btn.addEventListener('click', () => {
    const end = new Date();
    let start = new Date();
    const range = btn.dataset.range;
    if (range === '7') {
      start.setDate(start.getDate() - 6);
    } else if (range === 'month') {
      start = new Date(start.getFullYear(), start.getMonth(), 1);
    } else if (range === 'year') {
      start = new Date(start.getFullYear(), 0, 1);
    }
    const fmt = d => d.toISOString().slice(0,10);
    document.querySelector('input[name="fecha_inicio"]').value = fmt(start);
    document.querySelector('input[name="fecha_fin"]').value = fmt(end);
  });
});

document.getElementById('filters').addEventListener('change', (e) => {
  if(e.target.id !== 'exportTipo') document.getElementById('filters').submit();
});
document.getElementById('filters').addEventListener('submit', () => {
  spinner.classList.remove('hidden');
});
</script>
{% endblock %}

